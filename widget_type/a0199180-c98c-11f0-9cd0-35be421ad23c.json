{
  "entityType" : "WIDGET_TYPE",
  "entity" : {
    "fqn" : "tabla_de_paradas",
    "name" : "Tabla de paradas - Tiempos",
    "deprecated" : false,
    "image" : null,
    "description" : null,
    "descriptor" : {
      "type" : "timeseries",
      "sizeX" : 7.5,
      "sizeY" : 5,
      "resources" : [ ],
      "templateHtml" : "",
      "templateCss" : ".tb-scroll-container {\r\n  position: relative;      /* stays within widget bounds */\r\n  overflow-y: auto;        /* vertical scroll */\r\n  overflow-x: hidden;\r\n  -webkit-overflow-scrolling: touch; /* smooth on touch devices */\r\n}\r\n\r\n.mat-table {\r\n  width: 100%;\r\n  border-collapse: collapse;\r\n}\r\n\r\n.mat-cell {\r\n  font-family: 'Roboto', sans-serif; /* Roboto font */\r\n  font-size: 13px;                   /* Smaller font */\r\n  padding: 13px 13px;                /* More vertical padding = extra space top/bottom */\r\n  border-bottom: 1px solid #e0e0e0;\r\n}\r\n\r\n/*\r\n.mat-row:first-child .mat-cell {\r\n  border-top: 1px solid #e0e0e0;\r\n}\r\n*/\r\n\r\n.key-cell {\r\n  text-align: left;\r\n  font-weight: normal;\r\n  \r\n  white-space: normal;       /* prevent wrapping */\r\n  padding-right: 12px;        /* small gap before bar */\r\n  max-width: 250px;          /* adjust as needed */\r\n  min-width: 200px;          /* won‚Äôt shrink too much */\r\n  width: 1%;                 /* force auto-shrink */\r\n  overflow: hidden;\r\n  /*text-overflow: ellipsis;    ‚Ä¶ if text too long */\r\n}\r\n\r\n.value-cell {\r\n  text-align: left;          /* align bar to left edge */\r\n  width: 100%;               /* take all remaining space */\r\n}\r\n\r\n\r\n.mat-row:hover { \r\n  background-color: #f5f5f5; \r\n}\r\n\r\n.tb-search-container {\r\n  padding: 6px 5px 25px 0px;\r\n  background: transparent;\r\n  border-bottom: 1px solid #e0e0e0;\r\n  display: flex;               /* enable flexbox */\r\n  justify-content: flex-end;   /* push search to the right */\r\n}\r\n\r\n.tb-search {\r\n  width: 30%;                  /* half the container width */\r\n  max-width: 250px;            /* optional: prevent it from growing too big */\r\n  padding: 6px 10px;\r\n  font-size: 13px;\r\n  font-family: 'Roboto', sans-serif;\r\n  border: 1px solid #ccc;\r\n  border-radius: 4px;\r\n}\r\n\r\n.bar-container {\r\n  display: flex;\r\n  align-items: center;\r\n  height: 16px;\r\n}\r\n\r\n.bar-fill {\r\n  height: 100%;\r\n  border-radius: 3px;\r\n  transition: width 0.3s ease;   /* smooth update */\r\n}\r\n\r\n.bar-label {\r\n  margin-left: 6px;\r\n  font-size: 12px;\r\n  color: #444;   /* darker for readability */\r\n  white-space: nowrap;\r\n}\r\n\r\n.causa1-row { cursor: pointer; }\r\n\r\n.expander {\r\n    display: inline-block;\r\n    width: 16px;\r\n    font-weight: bold;\r\n}\r\n\r\n.causa2-row .causa2-indent {\r\n    padding-left: 20px;\r\n    color: #555;\r\n}\r\n\r\n.causa2-bar .bar-fill {\r\n    opacity: 0.7;\r\n}\r\n",
      "controllerScript" : "self.onInit = function () {\n    self.ctx.colorA = self.ctx.settings.color_a || \"#4CAF50\";\n    self.ctx.colorB = self.ctx.settings.color_b || \"#A5D7A7\";\n\n    self.ctx.table = {\n        body: $(\"<tbody></tbody>\"),\n        rows: {},\n        data: {}\n    };\n\n    self.ctx.expanded = {};   // <-- NEW\n\n    self.ctx.$container.append(\n        \"<div class='tb-scroll-container'>\" +\n        \"<table class='mat-table full-width'><tbody></tbody></table>\" +\n        \"</div>\"\n    );\n\n    $(\".mat-table tbody\", self.ctx.$container).replaceWith(self.ctx.table.body);\n    self.onResize();\n};\n\n\n\n\n// ‚úÖ Helper: validate if a value is meaningful\nfunction hasMeaningfulValue(v) {\n    if (v === null || v === undefined) return false;\n    if (typeof v === 'number') return isFinite(v); // keep 0\n    if (typeof v === 'boolean') return true; // keep false/true\n    if (typeof v === 'string') {\n        var s = v.trim();\n        if (!s) return false; // \"\", \" \"\n        if (s === '-' || s === '‚Äî') return false; // placeholders\n        if (s.toLowerCase() === 'null' || s.toLowerCase() === 'undefined') return false;\n        return true;\n    }\n    try {\n        var s = JSON.stringify(v);\n        return s && s !== '{}' && s !== '[]';\n    } catch (e) {\n        return false;\n    }\n}\n\n\n// ü™ü Resize handler\nself.onResize = function() {\n    var widgetHeight = self.ctx.height || self.ctx.$container.height();\n    var count = Math.max(self.ctx.datasources.length, 1);\n    var perHeight = Math.floor(widgetHeight / count);\n\n    // Apply height to every scroll container\n    $('.tb-scroll-container', self.ctx.$container).css({\n        height: perHeight + 'px',\n        maxHeight: perHeight + 'px'\n    });\n};\n\n\n// üìä Data update handler\nself.onDataUpdated = function () {\n\n    let table = self.ctx.table;\n    let dataArr = self.ctx.data[0];\n\n    if (!dataArr || !dataArr.data || !dataArr.data.length) return;\n\n    // Reset aggregated structures\n    table.data = {};\n\n    // 1Ô∏è‚É£ Parse ALL telemetry rows\n    dataArr.data.forEach(function (entry) {\n\n        let raw = entry[1];\n        if (!raw) return;\n\n        let parsed;\n        try { parsed = JSON.parse(raw); }\n        catch (e) { return; }\n\n        let causa1 = parsed.causa1;\n        let tiempo = parseFloat(parsed.tiempo_parada) || 0;\n        if (!causa1 || !isFinite(tiempo)) return;\n\n        // Build causa-path from causa2...5\n        let pathParts = [];\n        [\"causa2\", \"causa3\", \"causa4\", \"causa5\"].forEach(function (field) {\n            let v = parsed[field];\n            if (v && v.trim() !== \"-\" && v.trim() !== \"\") {\n                pathParts.push(v.trim());\n            }\n        });\n\n        let causaPath = pathParts.length ? pathParts.join(\" / \") : \"(Sin detalle)\";\n\n        // Create causa1 entry if missing\n        if (!table.data[causa1]) {\n            table.data[causa1] = {\n                sum: 0,\n                count: 0,\n                avg: 0,\n                causa2: {}    // second-level groups\n            };\n        }\n\n        let g1 = table.data[causa1];\n        g1.sum += tiempo;\n        g1.count++;\n\n        // Create causaPath entry if missing\n        if (!g1.causa2[causaPath]) {\n            g1.causa2[causaPath] = { sum: 0, count: 0, avg: 0 };\n        }\n\n        g1.causa2[causaPath].sum += tiempo;\n        g1.causa2[causaPath].count++;\n    });\n\n    // 2Ô∏è‚É£ Compute averages\n    Object.keys(table.data).forEach(function (c1) {\n        let g1 = table.data[c1];\n        g1.avg = g1.sum / g1.count;\n\n        Object.keys(g1.causa2).forEach(function (c2) {\n            let g2 = g1.causa2[c2];\n            g2.avg = g2.sum / g2.count;\n        });\n    });\n\n    // 3Ô∏è‚É£ Compute max for bar scaling (only top level)\n    let maxAvg = Math.max(\n        ...Object.values(table.data).map(x => x.avg),\n        1\n    );\n\n    // 4Ô∏è‚É£ REBUILD table\n    table.body.empty();\n\n    // Sort causa1 by avg\n    let sortedCausa1 = Object.keys(table.data)\n        .sort((a, b) => table.data[b].avg - table.data[a].avg);\n\n    sortedCausa1.forEach(function (c1) {\n\n        let g1 = table.data[c1];\n        let percent = (g1.avg / maxAvg) * 100;\n        let c1Id = \"c1_\" + c1.replace(/[^\\w\\-]/g, \"_\");\n\n        // ---------- main row ----------\n        let row =\n            \"<tr class='mat-row causa1-row' id='\" + c1Id + \"'>\" +\n            \"<td class='mat-cell key-cell'>\" +\n                \"<span class='expander'>‚ñ∂</span> \" + c1 +\n            \"</td>\" +\n            \"<td class='mat-cell value-cell'>\" +\n                \"<div class='bar-container'>\" +\n                    \"<div class='bar-fill' style='width:\" + percent +\n                    \"%; background: linear-gradient(90deg,\" +\n                    self.ctx.colorA + \",\" + self.ctx.colorB + \");'></div>\" +\n                    \"<span class='bar-label'>\" + g1.avg.toFixed(2) + \"</span>\" +\n                \"</div>\" +\n            \"</td>\" +\n            \"</tr>\";\n\n        table.body.append(row);\n\n        // ---------- hidden causa-PATH children ----------\n        Object.keys(g1.causa2)\n            .sort((a, b) => g1.causa2[b].avg - g1.causa2[a].avg)\n            .forEach(function (c2Path) {\n\n                let g2 = g1.causa2[c2Path];\n                let c2Percent = (g2.avg / g1.avg) * 100;\n\n                let childRow =\n                    \"<tr class='mat-row causa2-row child-of-\" + c1Id + \"' style='display:none'>\" +\n                    \"<td class='mat-cell key-cell causa2-indent'>‚Ü≥ \" + c2Path + \"</td>\" +\n                    \"<td class='mat-cell value-cell'>\" +\n                        \"<div class='bar-container causa2-bar'>\" +\n                            \"<div class='bar-fill' style='width:\" + c2Percent +\n                            \"%; background: linear-gradient(90deg,#888,#bbb);'></div>\" +\n                            \"<span class='bar-label'>\" + g2.avg.toFixed(2) + \"</span>\" +\n                        \"</div>\" +\n                    \"</td>\" +\n                    \"</tr>\";\n\n                table.body.append(childRow);\n            });\n\n        // 5Ô∏è‚É£ Add expander toggle with persistent state\n        let $row = $(\"#\" + c1Id, self.ctx.$container);\n\n        $row.off(\"click\").on(\"click\", function () {\n\n            let isOpen = self.ctx.expanded[c1];\n\n            if (isOpen) {\n                delete self.ctx.expanded[c1];\n                $(this).find(\".expander\").removeClass(\"open\").text(\"‚ñ∂\");\n                $(\".child-of-\" + c1Id).hide();\n            } else {\n                self.ctx.expanded[c1] = true;\n                $(this).find(\".expander\").addClass(\"open\").text(\"‚ñº\");\n                $(\".child-of-\" + c1Id).show();\n            }\n        });\n\n        // 6Ô∏è‚É£ Restore expansion state after rebuild\n        if (self.ctx.expanded[c1]) {\n            $(\"#\" + c1Id, self.ctx.$container).find(\".expander\")\n                .addClass(\"open\").text(\"‚ñº\");\n            $(\".child-of-\" + c1Id).show();\n        }\n\n    });\n    \n// ============================\n//  DASHBOARD STATE SYNC BLOCK\n// ============================\n\n    \n\n\n    let stateId = self.ctx.stateController.getStateId();\n    let currentParams = self.ctx.stateController.getStateParams();\n\n    let params = {};\n\n    let index = 1;\n    Object.keys(self.ctx.table.data).forEach(function(c1) {\n\n        let group = self.ctx.table.data[c1];\n\n        params[`parada_${index}_key`]   = c1;          // original name preserved\n        params[`parada_${index}_tiempo`]   = group.avg;\n        params[`parada_${index}_cantidad`] = group.count;\n\n        index++;\n    });\n    \n    let mergedParams = {\n            ...currentParams,\n            ...params\n        };\n\n    self.ctx.stateController.updateState(stateId, mergedParams, false);\n\n\n    \n};\n\n\n\n",
      "settingsForm" : [ {
        "id" : "color_a",
        "name" : "Color A",
        "group" : "Color",
        "type" : "color",
        "default" : "#000",
        "required" : false
      }, {
        "id" : "color_b",
        "name" : "Color B",
        "group" : "Color",
        "type" : "color",
        "default" : "#000"
      } ],
      "dataKeySettingsForm" : [ ],
      "hasBasicMode" : false,
      "defaultConfig" : "{\"datasources\":[{\"type\":\"function\",\"name\":\"function\",\"dataKeys\":[{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Random\",\"color\":\"#2196f3\",\"settings\":{},\"_hash\":0.15479322438769105,\"funcBody\":\"var value = prevValue + Math.random() * 100 - 50;\\nvar multiplier = Math.pow(10, 2 || 0);\\nvar value = Math.round(value * multiplier) / multiplier;\\nif (value < -1000) {\\n\\tvalue = -1000;\\n} else if (value > 1000) {\\n\\tvalue = 1000;\\n}\\nreturn value;\"},{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Cos\",\"color\":\"#4caf50\",\"settings\":{},\"_hash\":0.8416510464473642,\"funcBody\":\"return Math.round(1000*Math.cos(time/5000));\"},{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Sin\",\"color\":\"#f44336\",\"settings\":{},\"_hash\":0.9656098086761837,\"funcBody\":\"return Math.round(1000*Math.sin(time/5000));\"}],\"alarmFilterConfig\":{\"statusList\":[\"ACTIVE\"]}}],\"timewindow\":{\"realtime\":{\"timewindowMs\":60000}},\"showTitle\":true,\"backgroundColor\":\"#fff\",\"color\":\"rgba(0, 0, 0, 0.87)\",\"padding\":\"8px\",\"settings\":{\"color_a\":\"#4CAF50\",\"color_b\":\"#A5D7A7\"},\"title\":\"Tabla de paradas\",\"decimals\":null,\"useDashboardTimewindow\":true,\"displayTimewindow\":true,\"showTitleIcon\":false,\"titleTooltip\":\"\",\"dropShadow\":true,\"enableFullscreen\":false,\"widgetStyle\":{},\"widgetCss\":\".tb-widget .tb-widget-header {\\r\\n  position: absolute !important;\\r\\n  background: transparent !important;    /* solid background so it covers content */\\r\\n}\",\"titleStyle\":{\"fontSize\":\"24px\",\"fontWeight\":700,\"padding\":\"5px 10px 10px 5px\"},\"pageSize\":1024,\"noDataDisplayMessage\":\"\"}"
    },
    "externalId" : null,
    "resources" : null,
    "id" : {
      "entityType" : "WIDGET_TYPE",
      "id" : "a0199180-c98c-11f0-9cd0-35be421ad23c"
    },
    "scada" : false,
    "tags" : null
  },
  "relations" : [ ],
  "attributes" : {
    "SERVER_SCOPE" : [ ]
  }
}